<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>比赛回放</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            padding-bottom: 100px; /* 为底部的控制条留出空间 */
            background-color: #f9f9f9;
        }
        h1 { text-align: center; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        thead { position: sticky; top: 0; z-index: 10; }
        th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: center; white-space: nowrap; }
        thead th { background-color: #4CAF50; color: white; font-size: 16px; }
        tbody tr:nth-child(even) { background-color: #f2f2f2; }
        .ac { background-color: #d4edda !important; color: #155724; font-weight: bold; }
        .wa { background-color: #f8d7da !important; color: #721c24; }
        .pending { background-color: #d1ecf1 !important; color: #0c5460; font-weight: bold; }
        .solved-time { color: #6c757d; font-size: 0.8em; }

        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .controls button { font-size: 1.5em; padding: 5px 12px; cursor: pointer; border-radius: 5px; border: none; }
        .controls input[type="range"] { flex-grow: 1; margin: 0 15px; }
        .time-display { font-size: 1.5em; font-weight: bold; min-width: 120px; text-align: center; font-family: 'Courier New', Courier, monospace; }
        
        #frozen-banner {
            display: none;
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .admin-link {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 8px 15px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
        }
        #unfreeze-btn {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <h1>比赛回放</h1>
    <!-- 【新增】后台入口按钮 -->
    <a href="/update" target="_blank" class="admin-link">后台控制面板</a>
    <div id="frozen-banner">榜单已封！</div>

    <table>
        <thead id="board-header"></thead>
        <tbody id="board-body"></tbody>
    </table>

    <!-- 【恢复】统计表格容器 -->
    <div class="stats-container">
        <h2>题目统计</h2>
        <table class="stats-table">
            <thead id="stats-header"></thead>
            <tbody id="stats-body"></tbody>
        </table>
    </div>

    <!-- 【新增】解榜按钮 -->
    <div class="controls">
        <button id="play-pause-btn">▶</button>
        <span id="current-time-display" class="time-display">00:00</span>
        <input type="range" id="time-slider" min="0" max="300" value="0">
        <span id="total-time-display" class="time-display">05:00</span>
        <button id="unfreeze-btn" style="display: none;">解榜</button>
    </div>

    <script>
        // --- DOM Elements ---
        const boardHeader = document.getElementById('board-header');
        const boardBody = document.getElementById('board-body');
        const statsHeader = document.getElementById('stats-header');
        const statsBody = document.getElementById('stats-body');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const timeSlider = document.getElementById('time-slider');
        const currentTimeDisplay = document.getElementById('current-time-display');
        const totalTimeDisplay = document.getElementById('total-time-display');
        const frozenBanner = document.getElementById('frozen-banner');
        const unfreezeBtn = document.getElementById('unfreeze-btn');

        // --- State Variables ---
        let problems = [];
        let totalDurationMin = 300;
        let currentMinute = 0;
        let isPlaying = false;
        let playbackInterval;
        const FROZEN_BOARD_MINUTE = 240; // 4小时封榜
        let isUnfrozen = false; // 解榜状态

        // --- Functions ---
        function formatTime(minutes) {
            const h = String(Math.floor(minutes / 60)).padStart(2, '0');
            const m = String(minutes % 60).padStart(2, '0');
            return `${h}:${m}`;
        }

        async function updateBoardForTime(minutes) {
            currentMinute = minutes;
            timeSlider.value = minutes;
            currentTimeDisplay.textContent = formatTime(minutes);
            
            // 决定向API请求哪个时间点的数据
            let displayMinutes = minutes;
            if (!isUnfrozen && minutes >= FROZEN_BOARD_MINUTE) {
                displayMinutes = FROZEN_BOARD_MINUTE;
            }

            // UI提示条逻辑
            const showFrozenBanner = !isUnfrozen && minutes >= FROZEN_BOARD_MINUTE;
            frozenBanner.style.display = showFrozenBanner ? 'block' : 'none';
            unfreezeBtn.style.display = (minutes === totalDurationMin) ? 'block' : 'none';

            try {
                const response = await fetch(`/api/board_at_time/${displayMinutes}`);
                const data = await response.json();
                renderBoard(data.board, minutes); // 传入当前真实时间
                renderStatistics(data.statistics); // 恢复渲染统计
            } catch (error) {
                console.error("更新榜单失败:", error);
            }
        }

        function renderBoard(boardData, realMinutes) {
            let bodyHTML = '';
            boardData.forEach(team => {
                bodyHTML += `<tr><td>${team.rank}</td><td title="${team.team}" style="text-align: left; max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${team.team}</td><td>${team.solved}</td><td>${team.penalty}</td>`;
                problems.forEach(pid => {
                    const probInfo = team.status[pid];

                    // 【核心修改】使用 'final_effective_last_sub_time' 来判断是否显示 '?'
                    // 这个时间在AC后会被锁定，所以AC后再提交WA不会触发 '?'
                    const shouldShowPending = 
                        !isUnfrozen && 
                        realMinutes > FROZEN_BOARD_MINUTE && 
                        probInfo.final_effective_last_sub_time > FROZEN_BOARD_MINUTE &&
                        probInfo.final_effective_last_sub_time <= realMinutes;

                    if (shouldShowPending) {
                        
                        // 【核心修改】使用 'final_total_attempts' 来计算 '?' 后面的数字
                        // 这个数字包含了所有提交，包括AC后的
                        const attempts_before_pending = probInfo.final_total_attempts > 0 ? probInfo.final_total_attempts - 1 : 0;
                        
                        const content = attempts_before_pending > 0 ? `? ${attempts_before_pending}` : '?';
                        bodyHTML += `<td class="pending">${content}</td>`;
                    }
                    else if (probInfo.display.includes('+')) {
                        bodyHTML += `<td class="ac">${probInfo.display}<br><small class="solved-time">${probInfo.solved_time}</small></td>`;
                    } else if (probInfo.display.includes('-')) {
                        bodyHTML += `<td class="wa">${probInfo.display}</td>`;
                    } else {
                        bodyHTML += `<td></td>`;
                    }
                });
                bodyHTML += '</tr>';
            });
            boardBody.innerHTML = bodyHTML;
        }


        function renderStatistics(stats) {
            if (stats && Object.keys(stats).length > 0) {
                let statsHeaderHTML = '<tr><th>Statistic</th>';
                problems.forEach(pid => statsHeaderHTML += `<th>${pid}</th>`);
                statsHeaderHTML += '</tr>';
                statsHeader.innerHTML = statsHeaderHTML;

                let statsBodyHTML = '';
                const rowOrder = ['Submitted', 'Accepted', 'First Solved']; // 精简统计行
                rowOrder.forEach(rowName => {
                    if (stats[rowName]) {
                        statsBodyHTML += '<tr>';
                        statsBodyHTML += `<td class="stat-name">${rowName}</td>`;
                        problems.forEach(pid => {
                            const statValue = stats[rowName][pid] || '';
                            statsBodyHTML += `<td>${statValue}</td>`;
                        });
                        statsBodyHTML += '</tr>';
                    }
                });
                statsBody.innerHTML = statsBodyHTML;
            }
        }


        function togglePlayback() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                if (currentMinute >= totalDurationMin) { // 如果已在终点，则从头开始
                    currentMinute = 0;
                }
                playPauseBtn.textContent = '❚❚';
                playbackInterval = setInterval(() => {
                    if (currentMinute < totalDurationMin) {
                        updateBoardForTime(currentMinute + 1);
                    } else {
                        togglePlayback(); // 播放结束自动暂停
                    }
                }, 100); // 每100毫秒前进一分钟，可调速
            } else {
                playPauseBtn.textContent = '▶';
                clearInterval(playbackInterval);
            }
        }

        function unfreezeBoard() {
            isUnfrozen = true;
            unfreezeBtn.style.display = 'none';
            updateBoardForTime(totalDurationMin); // 立即更新到最终榜单
        }
        // --- Initialization ---
        async function initialize() {
            try {
                const response = await fetch('/api/initial_data');
                const data = await response.json();
                problems = data.problems;
                totalDurationMin = data.total_duration_min;

                timeSlider.max = totalDurationMin;
                totalTimeDisplay.textContent = formatTime(totalDurationMin);

                let headerHTML = '<tr><th>排名</th><th>队伍</th><th>解题数</th><th>罚时</th>';
                problems.forEach(pid => headerHTML += `<th>${pid}</th>`);
                headerHTML += '</tr>';
                boardHeader.innerHTML = headerHTML;

                await updateBoardForTime(0);
            } catch (error) {
                console.error("初始化页面失败:", error);
            }
        }

        // --- Event Listeners ---
        playPauseBtn.addEventListener('click', togglePlayback);
        timeSlider.addEventListener('input', (e) => {
            if (isPlaying) { // 如果正在播放，拖动时需要先暂停
                isPlaying = false;
                playPauseBtn.textContent = '▶';
                clearInterval(playbackInterval);
            }
            updateBoardForTime(parseInt(e.target.value));
        });
        unfreezeBtn.addEventListener('click', unfreezeBoard); // 绑定解榜事件
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>